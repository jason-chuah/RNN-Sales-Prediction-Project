# -*- coding: utf-8 -*-
"""test.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1RZU24Rw72JfQuz5Lzv22bY4lgty3LjuG
"""

import numpy as np
import pandas as pd
from sklearn.metrics import mean_absolute_percentage_error
from model import RNNModel
import torch

input_size = 1
hidden_size = 50
num_layers = 2
output_size = 6

df = pd.read_csv("test_example.csv", parse_dates=['Date'])
model = RNNModel(input_size, hidden_size, num_layers, output_size)
window_size = 10  # please fill in your own choice: this is the length of history you have to decide

# split the data set by the combination of `store` and `product``
gb = df.groupby(["store", "product"])
groups = {x: gb.get_group(x) for x in gb.groups}
scores = {}

for key, data in groups.items():
    # By default, we only take the column `number_sold`.
    # Please modify this line if your model takes other columns as input
    X = data['number_sold'].values  # convert to numpy array
    N = X.shape[0]  # total number of testing time steps

    mape_score = []
    start = window_size
    while start + 6 <= N:
        inputs = X[(start - window_size) : start]
        targets = X[start : (start + 6)]
        inputs = torch.tensor(inputs, dtype=torch.float32).unsqueeze(-1)
        # you might need to modify `inputs` before feeding it to your model, e.g., convert it to PyTorch Tensors
        # you might have a different name of the prediction function. Please modify accordingly
        model.load_state_dict(torch.load('best_model.pth'))
        model.eval()
        with torch.no_grad():
          predictions = model(inputs.unsqueeze(0)).squeeze(0).numpy()
        start += 6
        # calculate the performance metric
        mape_score.append(mean_absolute_percentage_error(targets, predictions))
    scores[key] = mape_score

# save the performance metrics to file
np.savez("score.npz", scores=scores)